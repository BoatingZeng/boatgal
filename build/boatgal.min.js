/*! boatgal 2016-05-03 */
var boatgal={};boatgal.canvasId="",boatgal.stage={},boatgal.queue={},boatgal.asset={},boatgal.config={},boatgal.scenario={},boatgal.status={},boatgal.status.renderObjFull={},boatgal.status.renderObjDiff={},boatgal.status.isTypeEnd=!1,boatgal.status.isChoosing=!1,boatgal.status.isEffectEnd=!1,boatgal.status.numPart="",boatgal.status.numChange=0,boatgal.isLoadSave=!1,boatgal.beginScenario=function(){function a(a){if(boatgal.status.isTypeEnd&&boatgal.status.isEffectEnd)if(b())galRenderer.render(boatgal.status.renderObjDiff);else if(a.target.gal_targetPart){boatgal.status.isChoosing=!1;var d=a.target.gal_targetPart;boatgal.status.numPart=d,boatgal.status.numChange=0,boatgal.status.renderObjFull=JSON.parse(JSON.stringify(boatgal.scenario[d][0])),c.removeChild(galRenderer.storage.choiceArea),galRenderer.render(boatgal.status.renderObjFull)}else boatgal.status.renderObjFull.branch&&!boatgal.status.isChoosing&&(boatgal.status.isChoosing=!0,galRenderer.showBranch(boatgal.status.renderObjFull.branch))}function b(){boatgal.status.numChange+=1;var a=boatgal.status.numChange,b=boatgal.status.numPart,c=boatgal.scenario[b][a];if(c){for(var d in c)boatgal.status.renderObjFull[d]=JSON.parse(JSON.stringify(c[d]));return c.effect||(boatgal.status.renderObjFull.effect=null),boatgal.status.renderObjDiff=c,!0}return!1}boatgal.isLoadSave?(boatgal.status.renderObjFull=JSON.parse(JSON.stringify(boatgal.config.save.renderObjFull)),boatgal.status.numPart=boatgal.config.save.numPart,boatgal.status.numChange=boatgal.config.save.numChange):(boatgal.status.renderObjFull=JSON.parse(JSON.stringify(boatgal.scenario.part0[0])),boatgal.status.numPart="part0",boatgal.status.numChange=0);var c=boatgal.stage;galRenderer.init(c),galRenderer.render(boatgal.status.renderObjFull),c.addEventListener("click",a)},boatgal.defaultTitle=function(){function a(){boatgal.beginScenario()}console.log("defaultTitle");var b=boatgal.stage.canvas.width,c=boatgal.stage.canvas.height,d=new createjs.Shape;d.graphics.beginFill("#000").drawRect(0,0,b,c);var e=new createjs.Text("Click to start","bold 50px 微软雅黑","#fff");e.set({x:b/2-200,y:c/2}),boatgal.stage.addChild(d,e),boatgal.stage.addEventListener("click",a)},boatgal.loadingScreen=function(){var a=boatgal.stage.canvas.width,b=boatgal.stage.canvas.height,c=new createjs.Shape;c.graphics.beginFill("#000").drawRect(0,0,a,b);var d={},e=new createjs.Text("Loading...","bold 50px 微软雅黑","#fff");return e.set({x:a/2-200,y:b/2}),boatgal.stage.addChild(c,e),d.text=e,d},boatgal.showTitle=function(){boatgal.stage.removeAllChildren(),boatgal.stage.removeAllEventListeners(),boatgal.queue.getResult("customTitle.js")?boatgal.customTitle():boatgal.defaultTitle()},boatgal.start=function(a,b){function c(){boatgal.stage.update()}function d(a){var b=100*a.loaded;g.text.text="Loading..."+b.toFixed()+"%"}function e(a){console.log("load error")}function f(){boatgal.asset=boatgal.queue.getResult("asset.json"),boatgal.scenario=boatgal.queue.getResult("scenario.json"),boatgal.config=boatgal.queue.getResult("config.json");var a=document.getElementById(b);a.width=boatgal.config.width,a.height=boatgal.config.height,boatgal.showTitle()}boatgal.canvasId=b,boatgal.stage=new createjs.Stage(b),createjs.Ticker.framerate=20,createjs.Ticker.removeAllEventListeners(),createjs.Ticker.addEventListener("tick",c);var g=boatgal.loadingScreen(),h=new createjs.LoadQueue;boatgal.queue=h,h.on("progress",d),h.on("error",e),h.on("complete",f),h.loadManifest(a)};var galRenderer={};galRenderer.storage={},galRenderer.effect={},galRenderer.createDialogBox=function(){var a=boatgal.config.width,b=boatgal.config.height,c=b/3,d=c/4,e=a/8,f=new createjs.Shape;return f.graphics.f("#000").mt(0,2*b/3).lt(e,2*b/3).at(e+d,2*b/3,e+d,2*b/3+d,d).lt(5*a/6,2*b/3+d).at(5*a/6+d,2*b/3+d,5*a/6+d,2*b/3+2*d,d).lt(5*a/6+d,b).lt(0,b).ef(),f.alpha=.5,f},galRenderer.init=function(a){var b=boatgal.config,c=(b.width,b.height);a.removeAllChildren(),a.removeAllEventListeners();var d=new createjs.Text("",b.dialogText.font,b.dialogText.color);d.set({x:10,y:2*c/3+50,lineHeight:1.5*d.getMeasuredLineHeight()}),galRenderer.storage.dialogText=d;var e=new createjs.Text("",b.speakerText.font,b.speakerText.color);e.set({x:10,y:2*c/3+10}),galRenderer.storage.speakerText=e;var f=galRenderer.createDialogBox();galRenderer.storage.dialogBox=f;var g=new createjs.Container;galRenderer.storage.figureBox=g;var h=new createjs.Bitmap;galRenderer.storage.bgBitmap=h,a.addChild(h,g,f,d,e)},galRenderer.render=function(a){function b(){g-=1,0===g&&(boatgal.status.isEffectEnd=!0,console.log("isEffectEnd = "+boatgal.status.isEffectEnd))}if(a.bg&&(a.bg.isEffect||(galRenderer.storage.bgBitmap.image=boatgal.queue.getResult(a.bg.id))),a.figures){var c=a.figures,d=galRenderer.storage.figureBox;d.removeAllChildren();for(var e=0;e<c.length;e++){var f=new createjs.Bitmap(boatgal.queue.getResult(c[e].id));f.name=c[e].id,f.x=c[e].position.x,f.y=c[e].position.y,c[e].isHide&&(f.alpha=0),d.addChild(f)}}if(a.dialog&&(galRenderer.storage.speakerText.text=a.dialog.speaker,galRenderer.type(galRenderer.storage.dialogText,a.dialog.speech)),a.effect){boatgal.status.isEffectEnd=!1;for(var g=a.effect.length,h=0;g>h;h++){var i=a.effect[h].name,j=galRenderer.effect[i],k=a.effect[h].wait,l=a.effect[h].attribute;setTimeout(j,k,l,b)}}else boatgal.status.isEffectEnd=!0},galRenderer.showBranch=function(a){var b=boatgal.stage,c=boatgal.config,d=c.width,e=(c.height,a.length),f=new createjs.Container;galRenderer.storage.choiceArea=f;for(var g=0;e>g;g++){var h=new createjs.Shape;h.graphics.beginFill("#000").drawRoundRect(d/3,50+100*g,d/3,50,25),h.alpha=.5,h.gal_targetPart=a[g].targetPart;var i=new createjs.Text("",c.otherText.font,c.otherText.color);i.text=a[g].text,i.x=d/3+20,i.y=50+100*g+10,f.addChild(h),f.addChild(i)}b.addChild(f)},galRenderer.type=function(a,b){function c(){h+1>i?(a.text=b.slice(0,i),i+=1,setTimeout(c,f)):(boatgal.status.isTypeEnd=!0,d())}function d(){boatgal.status.isTypeEnd===!0&&(a.text=a.text+"▼",galRenderer.type.timeOutIdObj.show=setTimeout(e,g))}function e(){boatgal.status.isTypeEnd===!0&&(a.text=a.text.slice(0,h),galRenderer.type.timeOutIdObj.hide=setTimeout(d,g))}clearTimeout(galRenderer.type.timeOutIdObj.show),clearTimeout(galRenderer.type.timeOutIdObj.hide);var f=50,g=500,h=b.length,i=1;boatgal.status.isTypeEnd=!1,c()},galRenderer.type.timeOutIdObj={},galRenderer.effect.bgSwitch=function(a,b){var c=galRenderer.effect.bgSwitch[a.method];c(b)},galRenderer.effect.bgSwitch.blur=function(a){function b(){f.cacheID&&f.updateCache()}function c(){f.image=boatgal.queue.getResult(boatgal.status.renderObjFull.bg.id)}function d(){createjs.Ticker.removeEventListener("tick",b),f.uncache(),a()}var e=20,f=galRenderer.storage.bgBitmap,g=new createjs.BlurFilter(0,0,1);f.filters=[g],f.cache(0,0,f.image.width,f.image.height),createjs.Ticker.addEventListener("tick",b),createjs.Tween.get(g).to({blurX:e,blurY:e},300).call(c).to({blurX:0,blurY:0},500).call(d)},galRenderer.effect.bgSwitch.fade=function(a){function b(){c.image=boatgal.queue.getResult(boatgal.status.renderObjFull.bg.id)}var c=galRenderer.storage.bgBitmap;createjs.Tween.get(c).to({alpha:.7},200,createjs.Ease.getPowOut(2.2)).call(b).to({alpha:1},200,createjs.Ease.getPowOut(2.2)).call(a)},galRenderer.effect.bgSwitch.mask=function(a){function b(){f.image=boatgal.queue.getResult(boatgal.status.renderObjFull.bg.id),boatgal.stage.removeChild(e),a()}var c=boatgal.config.width,d=boatgal.config.height,e=new createjs.Bitmap;e.image=boatgal.queue.getResult(boatgal.status.renderObjFull.bg.id);var f=galRenderer.storage.bgBitmap,g=new createjs.Shape;g.graphics.rect(c,0,c,d),e.mask=g,createjs.Tween.get(g).to({x:-c},200).call(b),boatgal.stage.addChildAt(e,boatgal.stage.getChildIndex(f)+1)},galRenderer.effect.fade=function(a,b){var c=0;a.isFadein&&(c=1),createjs.Tween.get(galRenderer.storage.figureBox.getChildByName(a.target)).to({alpha:c},a.duration).call(b)};